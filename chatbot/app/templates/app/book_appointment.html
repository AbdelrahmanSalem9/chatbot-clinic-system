<!DOCTYPE html>
<html>

<head>
    {% load static %}
    <title>Book Appointment</title>
</head>
<link rel="stylesheet" href="{% static 'css/book_appointment.css' %}">

<body>
    <h1>Book Appointment</h1>
    <form id="availability-form" method="POST">
        {% csrf_token %}
        <label for="doctor">Select a doctor:</label>
        <select name="doctor" id="doctor">
            {% for doctor in doctors %}
            <option value="{{ doctor.pk }}">{{ doctor.name }}</option>
            {% endfor %}
        </select>
        <label for="date">Select a date:</label>
        <input type="date" name="date" id="date">
    </form>
    <div id="available-time-slots">
        {% if available_time_slots %}
        <h2>Available time slots:</h2>
        <ul>
            {% for time_slot in available_time_slots %}
            <li>{{ time_slot }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div style="display:none;" class="confirm-box" id="confirmation-message">
        <p>Confirm you appointment ?</p>
        <div id="confirmation-data"></div>
        <button id="confirm-button">Confirm</button>
        <button id="cancel-button">Cancel</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var dateInput = document.getElementById('date');
            dateInput.addEventListener('change', function () {
                var selectedDate = dateInput.value;
                var doctorId = document.getElementById('doctor').value;
                var xhr1 = new XMLHttpRequest();
                xhr1.open('GET', '/check_availability/?doctor=' + doctorId + '&date=' + selectedDate);
                xhr1.onload = function () {
                    if (xhr1.status === 200) {
                        // Update the page with the available time slots
                        var response = JSON.parse(xhr1.responseText);
                        var availableTimeSlots = response.available_time_slots;
                        var timeSlotsList = document.getElementById('available-time-slots');
                        timeSlotsList.innerHTML = '';
                        var slotContainer = document.getElementById("available-time-slots");

                        for (var i = 0; i < availableTimeSlots.length; i++) {
                            // create the button element
                            var slotButton = document.createElement("button");
                            slotButton.classList.add("time-slot");
                            slotButton.innerText = new Date(availableTimeSlots[i]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                            // add a click event listener to the button
                            slotButton.addEventListener("click", function () {

                                const confirmationMessage = document.getElementById("confirmation-message");
                                const confirmButton = document.getElementById("confirm-button");
                                const cancelButton = document.getElementById("cancel-button");
                                confirmationMessage.style.display = "block";
                                confirmButton.addEventListener("click", function () {
                                    confirmButton.disabled = true;
                                    // Perform the action
                                    confirmationMessage.style.display = "none";
                                    // get the selected doctor ID and email
                                    var doctorId = document.getElementById("doctor").value;

                                    // get the selected time slot
                                    var selectedSlot = slotButton.innerText;
                                    var selectedDateTime = new Date(selectedDate + ' ' + selectedSlot);
                                    // send a POST request to book the appointment
                                    var xhr2 = new XMLHttpRequest();
                                    xhr2.open("POST", window.location.href);
                                    xhr2.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                                    xhr2.setRequestHeader("X-CSRFToken", document.getElementsByName("csrfmiddlewaretoken")[0].value);
                                    xhr2.onload = function () {
                                        if (xhr2.status === 200) {
                                            var response = JSON.parse(xhr2.responseText);
                                            alert(response.message); // show the confirmation message
                                            window.location.href = "/chat";
                                        }
                                    };
                                    var data = {
                                        "doctor_id": doctorId,
                                        "date": selectedDate,
                                        "time_slot": selectedDateTime.toISOString(),
                                        "patient_email": "{{ patient_email }}",
                                    };
                                    xhr2.send(JSON.stringify(data));
                                    slotButton.style.visibility = "hidden";
                                });
                                cancelButton.addEventListener("click", function () {
                                    // Perform the action
                                    confirmationMessage.style.display = "none";
                                });
                                confirmationData = document.getElementById("confirmation-data");
                                // TODO: Always get the value of the button as the last slot 
                                confirmationData.innerHTML = "Patient: {{ patient_email }}<br>Doctor: " + document.getElementById("doctor").options[document.getElementById("doctor").selectedIndex].text + "<br>Date: " + selectedDate + "<br>Time: " + slotButton.innerText;
                            });
                            // add the button to the container
                            slotContainer.appendChild(slotButton);
                        }
                    } else {
                        console.log('Request failed.  Returned status of ' + xhr1.status);
                    }
                };
                xhr1.send(); // Suspicisions
            });
        });
    </script>
</body>

</html>