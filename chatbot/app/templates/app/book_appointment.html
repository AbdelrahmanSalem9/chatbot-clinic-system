<!DOCTYPE html>
<html>

<head>
    {% load static %}
    <title>Book Appointment</title>
</head>
<style>
    .confirm-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border: 1px solid black;
        padding: 20px;
        text-align: center;
    }
</style>

<body>
    <h1>Book Appointment</h1>
    <div id="calendar"></div>
    <form id="availability-form" method="POST">
        {% csrf_token %}
        <label for="doctor">Select a doctor:</label>
        <select name="doctor" id="doctor">
            {% for doctor in doctors %}
            <option value="{{ doctor.pk }}">{{ doctor.name }}</option>
            {% endfor %}
        </select>
        <label for="date">Select a date:</label>
        <input type="date" name="date" id="date">
    </form>
    <div id="available-time-slots">
        {% if available_time_slots %}
        <h2>Available time slots:</h2>
        <ul>
            {% for time_slot in available_time_slots %}
            <li>{{ time_slot }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div style="display:none;" class="confirm-box" id="confirmation-message">
        <p>Are you sure you want to proceed?</p>
        <button id="confirm-button">Confirm</button>
        <button id="cancel-button">Cancel</button>
    </div>
    <script>
        function showConfirmation() {
            var message = "Are you sure you want to proceed?";
            var result = confirm(message);
            if (result) {
                // If the user clicks "OK", do something
                alert("You clicked OK!");
            } else {
                // If the user clicks "Cancel", do something else
                alert("You clicked Cancel!");
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            var dateInput = document.getElementById('date');
            dateInput.addEventListener('change', function () {
                var selectedDate = dateInput.value;
                var doctorId = document.getElementById('doctor').value;
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/check_availability/?doctor=' + doctorId + '&date=' + selectedDate);
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        // Update the page with the available time slots
                        var response = JSON.parse(xhr.responseText);
                        var availableTimeSlots = response.available_time_slots;
                        var timeSlotsList = document.getElementById('available-time-slots');
                        timeSlotsList.innerHTML = '';
                        var slotContainer = document.getElementById("available-time-slots");

                        for (var i = 0; i < availableTimeSlots.length; i++) {
                            // create the button element
                            var slotButton = document.createElement("button");
                            slotButton.classList.add("time-slot");
                            slotButton.innerText = new Date(availableTimeSlots[i]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                            // add a click event listener to the button
                            slotButton.addEventListener("click", function () {

                                const confirmationMessage = document.getElementById("confirmation-message");
                                const confirmButton = document.getElementById("confirm-button");
                                const cancelButton = document.getElementById("cancel-button");
                                confirmationMessage.style.display = "block";
                                confirmButton.addEventListener("click", function () {
                                    // Perform the action
                                    confirmationMessage.style.display = "none";
                                    // get the selected doctor ID and email
                                    var doctorId = document.getElementById("doctor").value;

                                    // get the selected time slot
                                    var selectedSlot = slotButton.innerText;
                                    var selectedDateTime = new Date(selectedDate + ' ' + selectedSlot);
                                    // send a POST request to book the appointment
                                    var xhr = new XMLHttpRequest();
                                    xhr.open("POST", "/book_appointment/");
                                    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                                    xhr.onload = function () {
                                        if (xhr.status === 200) {
                                            var response = JSON.parse(xhr.responseText);
                                            alert(response.message); // show the confirmation message
                                            window.location.href = "/chat?appointment_id=" + response.appointment_id;
                                        }
                                    };
                                    var data = {
                                        "doctor_id": doctorId,
                                        "date": selectedDate,
                                        "time_slot": selectedDateTime.toISOString(),
                                        "patient_email": "{{ patient_email }}",
                                    };
                                    xhr.send(JSON.stringify(data));
                                    slotButton.style.visibility = "hidden";
                                });
                                cancelButton.addEventListener("click", function () {
                                    // Perform the action
                                    confirmationMessage.style.display = "none";
                                });
                            });
                            // add the button to the container
                            slotContainer.appendChild(slotButton);
                        }
                    } else {
                        console.log('Request failed.  Returned status of ' + xhr.status);
                    }
                };
                xhr.send();
            });
        });
    </script>
    <link rel="stylesheet" href="{% static 'css/book_appointment.css' %}">
</body>

</html>